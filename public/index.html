<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pensi√≥n UTM - Inicio</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="App para gestionar pagos de pensi√≥n alimenticia basados en UTM">
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pensi√≥n UTM">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon e iconos -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/mobile-nav.css">
</head>
<body>
    <!-- NAVEGACI√ìN M√ìVIL MINIMALISTA -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">Pensi√≥n UTM</a>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/" class="nav-link" id="nav-home">
                        <span class="nav-icon">üè†</span>
                        <span class="nav-text">Inicio</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/calculadora.html" class="nav-link" id="nav-calc">
                        <span class="nav-icon">üßÆ</span>
                        <span class="nav-text">Calcular</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/pagos.html" class="nav-link" id="nav-pagos">
                        <span class="nav-icon">üí≥</span>
                        <span class="nav-text">Pagos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/historial.html" class="nav-link" id="nav-historial">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-text">Historial</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content">
        <div class="container">
            <!-- Bienvenida simplificada -->
            <div class="card fade-in">
                <div class="card-header">
                    üí∞ Pensi√≥n Alimenticia UTM
                </div>
                <div class="card-body">
                    <p>Gestiona tus pagos basados en UTM oficial</p>
                    
                    <!-- Estado de conexi√≥n minimalista -->
                    <div style="margin-top: 1rem;">
                        <div id="connectionStatus" class="connection-status">
                            <div id="statusDot" class="status-dot status-offline"></div>
                            <span id="statusText">Verificando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADVERTENCIA IMPORTANTE SOBRE DATOS -->
            <div class="card" style="border-left: 4px solid #f44336; background: rgba(244, 67, 54, 0.05);">
                <div class="card-header">‚ö†Ô∏è Importante - Tus Datos</div>
                <div class="card-body">
                    <p>Tus datos se guardan <strong>solo en tu dispositivo</strong>.</p>
                    <p>Si desinstalas la app o cambias de celular, se perder√°n.</p>
                    
                    <div style="margin-top: 1rem;">
                        <a href="/backup.html" class="btn btn-primary">
                            üõ°Ô∏è Hacer Backup de Datos
                        </a>
                    </div>
                </div>
            </div>

            <!-- Navegaci√≥n principal con 3 opciones principales -->
            <div class="nav-grid">
                <div class="card slide-up">
                    <div class="card-header">üßÆ Calcular</div>
                    <div class="card-body">
                        <p>Calcula el monto mensual seg√∫n UTM oficial</p>
                        <a href="/calculadora.html" class="btn btn-primary">Calcular Ahora</a>
                    </div>
                </div>

                <div class="card slide-up">
                    <div class="card-header">üí≥ Registrar</div>
                    <div class="card-body">
                        <p>Anota los pagos realizados</p>
                        <a href="/pagos.html" class="btn btn-success">Agregar Pago</a>
                    </div>
                </div>

                <div class="card slide-up">
                    <div class="card-header">üìä Historial</div>
                    <div class="card-body">
                        <p>Consulta pagos anteriores</p>
                        <a href="/historial.html" class="btn btn-primary">Ver Historial</a>
                    </div>
                </div>
            </div>

            <!-- Resumen compacto -->
            <div class="card slide-up">
                <div class="card-header">üìã Resumen</div>
                <div class="card-body">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-number" id="totalPagos">0</div>
                            <div class="summary-label">Pagos</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="montoTotal">$0</div>
                            <div class="summary-label">Total</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="ultimoPago">-</div>
                            <div class="summary-label">√öltimo</div>
                        </div>
                    </div>
                    
                    <!-- Bot√≥n de backup en el resumen -->
                    <div style="margin-top: 1rem; text-align: center;">
                        <a href="/backup.html" class="btn btn-primary" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                            üõ°Ô∏è Backup
                        </a>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n esencial -->
            <div class="card">
                <div class="card-header">‚ÑπÔ∏è Factor UTM</div>
                <div class="card-body">
                    <p><strong>Monto fijo:</strong> 3.51360 UTM</p>
                    <p><strong>Se actualiza:</strong> Seg√∫n valor UTM mensual oficial</p>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="/js/app.js"></script>
    <script src="/js/utm-api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè† Inicio - Dise√±o minimalista cargado');
            
            // Marcar navegaci√≥n activa
            setActiveNavItem();
            
            // Registrar Service Worker
            registrarServiceWorker();
            
            // Cargar resumen
            cargarResumenRapido();
            
            // Verificar estado de conexi√≥n
            verificarEstadoConexion();
            
            // Verificar si es la primera vez que usa la app
            verificarPrimeraVez();
        });

        function setActiveNavItem() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById('nav-home').classList.add('active');
        }

        async function registrarServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úÖ Service Worker registrado');
                } catch (error) {
                    console.log('‚ùå Error registrando Service Worker:', error);
                }
            }
        }

        async function verificarEstadoConexion() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            try {
                if (typeof UTMAPI !== 'undefined') {
                    await UTMAPI.obtenerUTMActual();
                    statusDot.className = 'status-dot status-online';
                    statusText.textContent = 'Online';
                } else {
                    throw new Error('API no disponible');
                }
            } catch (error) {
                statusDot.className = 'status-dot status-offline';
                statusText.textContent = 'Offline';
            }
        }

        function cargarResumenRapido() {
            try {
                const pagosGuardados = localStorage.getItem('pension_pagos');
                let totalPagos = 0;
                let montoTotal = 0;
                let ultimoPago = '-';
                
                if (pagosGuardados) {
                    const pagos = JSON.parse(pagosGuardados);
                    totalPagos = pagos.length;
                    montoTotal = pagos.reduce((total, pago) => total + (pago.monto || 0), 0);
                    
                    if (pagos.length > 0) {
                        const pagoReciente = pagos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
                        ultimoPago = new Date(pagoReciente.fecha).toLocaleDateString('es-CL', {
                            day: '2-digit',
                            month: '2-digit'
                        });
                    }
                }
                
                document.getElementById('totalPagos').textContent = totalPagos;
                document.getElementById('montoTotal').textContent = formatearPesos(montoTotal);
                document.getElementById('ultimoPago').textContent = ultimoPago;
                
            } catch (error) {
                console.error('‚ùå Error cargando resumen:', error);
            }
        }

        function verificarPrimeraVez() {
            // Verificar si es la primera vez que usa la app
            const primeraVez = !localStorage.getItem('pension_pagos');
            const yaSeAdvirtio = localStorage.getItem('pension_backup_warning_shown');
            
            if (primeraVez && !yaSeAdvirtio) {
                // Mostrar advertencia despu√©s de 3 segundos
                setTimeout(() => {
                    const mostrarWarning = confirm(
                        'üõ°Ô∏è IMPORTANTE - Backup de Datos\n\n' +
                        'Tus datos se guardan solo en tu dispositivo.\n\n' +
                        'Si desinstalas la app o cambias de celular, se perder√°n.\n\n' +
                        '¬øQuieres ver c√≥mo hacer backup de tus datos?'
                    );
                    
                    if (mostrarWarning) {
                        window.location.href = '/backup.html';
                    }
                    
                    // Marcar que ya se mostr√≥ la advertencia
                    localStorage.setItem('pension_backup_warning_shown', 'true');
                }, 3000);
            }
        }

        function formatearPesos(cantidad) {
            if (cantidad === 0) return '$0';
            
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(cantidad);
        }

        // Listeners para estado de conexi√≥n
        window.addEventListener('online', verificarEstadoConexion);
        window.addEventListener('offline', () => {
            document.getElementById('statusDot').className = 'status-dot status-offline';
            document.getElementById('statusText').textContent = 'Offline';
        });
    </script>
</body>
</html>